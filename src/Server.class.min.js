function getUrl(n){var t=n.headers.referer!==undefined?n.headers.referer.split(":")[0]:"http";return host=t+"://"+n.headers.host}var __extends=this.__extends||function(n,t){function i(){this.constructor=n}i.prototype=t.prototype,n.prototype=new i},fs=require("fs"),util=require("util"),host="",hproxywarn=!1,clientUrl={},ELog=console,Eureca;(function(n){var t=function(t){function i(i){typeof i=="undefined"&&(i={}),t.call(this),this.settings=i,this.scriptCache="",this.stub=new n.Stub(i),i.transport=i.transport||"engine.io",console.log("* using "+i.transport),this.transport=n.Transport.get(i.transport),this.contract=[],this.debuglevel=i.debuglevel||1;this.exports=n.Contract.proxify({},this.contract),this.allowedF=[],this.clients={},this.registerEvents(["onConnect","onDisconnect","onMessage","onError"])}return __extends(i,t),i.prototype.getClient=function(n){var t=this.clients[n];return t===undefined?!1:t.client!==undefined?t.client:(t.client={},this.stub.importRemoteFunction(t.client,t,this.allowedF),t.client)},i.prototype.getConnection=function(n){return this.clients[n]},i.prototype.sendScript=function(n,t,i){if(this.scriptCache!=""){t.writeHead(200),t.write(this.scriptCache),t.end();return}this.scriptCache="",this.scriptCache+=fs.readFileSync(__dirname+this.transport.script),this.scriptCache+='\nvar _eureca_prefix = "'+i+'";\n',this.scriptCache+='\nvar _eureca_uri = "'+getUrl(n)+'";\n',this.scriptCache+='\nvar _eureca_host = "'+getUrl(n)+'";\n',this.scriptCache+=fs.readFileSync(__dirname+"/EurecaClient.js"),t.writeHead(200),t.write(this.scriptCache),t.end()},i.prototype._handleServer=function(t){var i=this;t.onconnect(function(t){t.eureca={},t.eureca.remoteAddress=t.remoteAddress,i.clients[t.id]=t,i.contract=n.Contract.ensureContract(i.exports,i.contract),t.send(JSON.stringify({__eureca__:i.contract})),i.trigger("onConnect",t);t.onmessage(function(n){var r,u;i.trigger("onMessage",n);try{r=JSON.parse(n)}catch(f){}if(r!==undefined){if(r.f!==undefined){u={user:{clientId:t.id},connection:t},i.stub.invoke(u,i,r,t);return}if(r._r!==undefined){i.stub.doCallBack(r._r,r.r);return}}});t.onerror(function(n){i.trigger("onError",n)});t.onclose(function(){i.trigger("onDisconnect",t),delete i.clients[t.id]})})},i.prototype._checkHarmonyProxies=function(){typeof Proxy!="undefined"||hproxywarn||(ELog.log("!!WARNING!! !!WARNING!! !!WARNING!! !!WARNING!! !!WARNING!! !!WARNING!! !!WARNING!!  ","",""),ELog.log("I","Harmony proxy not found","using workaround"),ELog.log("I","to avoid this message please use : node --harmony-proxies <app>",""),ELog.log("=====================================================================================","",""),hproxywarn=!0)},i.prototype.listen=function(n){this._checkHarmonyProxies(),this.allowedF=this.settings.allow||[];var t=this.settings.prefix||"eureca.io",i=this.transport.createServer(n,{path:"/"+t}),r=this;this._handleServer(i)},i.prototype.installSockJs=function(n,t){var i=require("sockjs"),r=i.createServer();r.installHandlers(n,t)},i.prototype.attach=function(n){var t=n;n._events.request!==undefined&&n.routes===undefined&&(t=n._events.request),this._checkHarmonyProxies(),this.allowedF=this.settings.allow||[];var i=this.settings.prefix||"eureca.io",r=this.settings.clientScript||"/eureca.js",f=this.transport.createServer(n,{prefix:i}),u=this;if(this._handleServer(f),t.get)t.get(r,function(n,t){u.sendScript(n,t,i)});else t.on("request",function(n,t){n.method==="GET"&&n.url.split("?")[0]===r&&u.sendScript(n,t,i)})},i}(n.EObject);n.Server=t})(Eureca||(Eureca={})),exports.Eureca=Eureca